<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0b0f19">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Magical Common Centroid Simulator</title>
    
    <!-- PWA Manifest (Embedded) -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiTWFnaWNhbCBMYXlvdXQgTGFiIiwic2hvcnRfbmFtZSI6IkxheW91dExhYiIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMGIwZjE5IiwidGhlbWVfY29sb3IiOiIjMGIwZjE5IiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCw8c3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDEwMCAxMDAnPjx0ZXh0IHk9JzkwJyBmb250LXNpemU9JzkwJz7imqHvuI88L3RleHQ+PC9zdmc+Iiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%230b0f19'/><text y='80' x='10' font-size='70'>‚ö°</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import Magical Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        /* Magical Theme Variables */
        :root {
            --bg-dark: #0f172a;
            --parchment: #f0e6d2;
            --gold-accent: #d4af37;
            --gold-dim: #8a7326;
            --border-color: #4a3b2a;
        }

        body { 
            font-family: 'Crimson Text', serif; 
            background-color: #0b0f19;
            /* Starry/Magical Background */
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
            color: var(--parchment);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        
        h1, h2, h3, .magic-font { font-family: 'Cinzel', serif; }

        /* Custom Scrollbar - Magical Scroll */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(to bottom, var(--gold-dim), var(--gold-accent), var(--gold-dim));
            border-radius: 5px;
            border: 2px solid #1a1a1a;
        }

        /* Magical Panels */
        .magic-panel {
            background: rgba(16, 20, 30, 0.85);
            border: 1px solid var(--gold-dim);
            box-shadow: 0 0 15px rgba(0,0,0,0.8), inset 0 0 20px rgba(0,0,0,0.5);
            position: relative;
            backdrop-filter: blur(5px);
        }
        /* Corner Ornaments */
        .magic-panel::before {
            content: '';
            position: absolute;
            top: 2px; left: 2px; right: 2px; bottom: 2px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            pointer-events: none;
            z-index: 0;
        }

        /* Buttons - Enchanted */
        .btn-magic {
            background: linear-gradient(to bottom, #2d3748, #1a202c);
            border: 1px solid var(--gold-dim);
            color: var(--gold-accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Cinzel', serif;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-magic:hover {
            box-shadow: 0 0 15px var(--gold-dim);
            text-shadow: 0 0 5px var(--gold-accent);
            border-color: var(--gold-accent);
            transform: translateY(-1px);
        }
        .btn-magic:active { transform: translateY(1px); }

        /* Grid Cells - Runes/Devices */
        .rune-cell { 
            transition: all 0.2s;
            font-family: 'Cinzel', serif;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .rune-cell:hover { 
            z-index: 10; 
            transform: scale(1.1); 
            box-shadow: 0 0 15px var(--gold-accent); 
            border-color: var(--gold-accent); 
        }

        /* Range Slider - Wand Style */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px; width: 18px;
            border-radius: 50%;
            background: var(--gold-accent);
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 0 10px var(--gold-accent);
            border: 2px solid #2d3748;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 2px;
            background: var(--gold-dim);
        }

        /* Inputs */
        input[type=number] {
            font-family: 'Cinzel', serif;
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--gold-dim);
            color: var(--parchment);
            text-align: center;
        }
        input[type=number]:focus {
            border-color: var(--gold-accent);
            box-shadow: 0 0 5px var(--gold-accent);
            outline: none;
        }

        /* Loading Spinner - Spell Circle */
        .spell-loader {
            width: 40px; height: 40px;
            border: 2px solid transparent;
            border-top-color: var(--gold-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: relative;
        }
        .spell-loader::before {
            content: '';
            position: absolute;
            top: 5px; left: 5px; right: 5px; bottom: 5px;
            border: 2px solid transparent;
            border-top-color: #9f7aea;
            border-radius: 50%;
            animation: spin 2s linear infinite reverse;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Stats Table */
        .stats-table th { 
            border-bottom: 1px solid var(--gold-dim); 
            color: var(--gold-accent); 
            font-family: 'Cinzel', serif;
        }
        .stats-table td { border-bottom: 1px solid rgba(138, 115, 38, 0.2); }

        .mobile-touch-target { min-height: 48px; }
    </style>
</head>
<body class="min-h-screen flex flex-col pb-10 safe-area-inset-bottom">

    <!-- Header -->
    <header class="p-5 border-b border-[#4a3b2a] bg-[#0b0f19]/90 backdrop-blur-md sticky top-0 z-20 shadow-lg safe-area-inset-top">
        <div class="max-w-7xl mx-auto flex justify-between items-center relative">
            <!-- Decorative line -->
            <div class="absolute bottom-0 left-0 w-full h-[1px] bg-gradient-to-r from-transparent via-[#d4af37] to-transparent opacity-50"></div>
            
            <h1 class="text-xl md:text-2xl font-bold tracking-wide flex items-center gap-3 text-[#d4af37]">
                <span class="text-3xl filter drop-shadow-[0_0_5px_rgba(212,175,55,0.8)]">‚ö°</span>
                <div class="flex flex-col">
                    <span class="magic-font leading-none">Common Centroid</span>
                    <span class="text-[10px] text-gray-400 font-serif tracking-widest uppercase mt-1">Hogwarts Layout Dept.</span>
                </div>
            </h1>
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto w-full p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 relative z-10">
        
        <!-- Left Sidebar: Controls -->
        <!-- Order-1 ensures this block appears first on mobile devices -->
        <div class="lg:col-span-4 space-y-6 order-1 lg:order-1">
            
            <!-- Parameters (Moved to Top for Mobile Accessibility) -->
            <div class="magic-panel p-6 rounded-sm space-y-5">
                
                <!-- 1. Grid Size -->
                <div>
                    <h2 class="text-[#d4af37] font-bold mb-3 text-sm border-b border-[#4a3b2a] pb-1 flex items-center gap-2">
                        <span class="magic-font">I. Array Matrix</span>
                    </h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] text-gray-400 uppercase tracking-widest mb-1 text-center">Columns (X)</label>
                            <div class="flex items-center gap-2">
                                <button onclick="adjustVal('colInput', -1)" class="w-8 h-8 rounded border border-[#4a3b2a] text-[#d4af37] hover:bg-white/5 active:bg-white/10">-</button>
                                <input type="number" id="colInput" value="4" min="2" max="20" class="w-full h-8 rounded text-lg" readonly>
                                <button onclick="adjustVal('colInput', 1)" class="w-8 h-8 rounded border border-[#4a3b2a] text-[#d4af37] hover:bg-white/5 active:bg-white/10">+</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-400 uppercase tracking-widest mb-1 text-center">Rows (Y)</label>
                            <div class="flex items-center gap-2">
                                <button onclick="adjustVal('rowInput', -1)" class="w-8 h-8 rounded border border-[#4a3b2a] text-[#d4af37] hover:bg-white/5 active:bg-white/10">-</button>
                                <input type="number" id="rowInput" value="4" min="1" max="20" class="w-full h-8 rounded text-lg" readonly>
                                <button onclick="adjustVal('rowInput', 1)" class="w-8 h-8 rounded border border-[#4a3b2a] text-[#d4af37] hover:bg-white/5 active:bg-white/10">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Components -->
                <div>
                    <h2 class="text-[#d4af37] font-bold mb-3 text-sm border-b border-[#4a3b2a] pb-1 flex justify-between items-center">
                        <span class="magic-font">II. Device Types</span>
                        <span class="text-[10px] text-gray-500">Count: <span id="deviceCountVal" class="text-[#d4af37] text-base font-bold">2</span></span>
                    </h2>
                    
                    <div class="mb-4 px-1">
                        <input type="range" id="deviceCountInput" min="2" max="8" value="2" class="w-full h-8">
                    </div>

                    <div id="quantityInputsContainer" class="grid grid-cols-2 gap-3 max-h-40 overflow-y-auto p-1 pr-2">
                        <!-- JS generated inputs -->
                    </div>

                    <div class="mt-4 text-xs flex justify-between items-center bg-black/40 p-2 rounded border border-[#4a3b2a]">
                        <span class="text-gray-400 uppercase tracking-wider">Total Cells</span>
                        <span id="capacityStatus" class="font-serif text-lg text-gray-200">0 / 16</span>
                    </div>
                </div>

                <div class="pt-4 mt-2">
                    <button onclick="generateGrid()" class="btn-magic mobile-touch-target w-full text-red-300 border-red-900/60 hover:text-red-100 hover:border-red-500 rounded-sm flex items-center justify-center gap-2">
                        <span>‚ùå</span>
                        Reset Grid
                    </button>
                </div>
            </div>

            <!-- AI Core (Wizard Advisor) -->
            <div class="magic-panel p-6 rounded-sm">
                <h2 class="text-purple-300 font-bold mb-4 text-sm tracking-wider uppercase border-b border-purple-900/50 pb-2 flex items-center gap-2">
                    <span class="text-xl">üîÆ</span>
                    <span class="magic-font">AI Layout Assistant</span>
                </h2>
                
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="askAiToGenerate()" id="btnAiGen" class="btn-magic mobile-touch-target py-3 px-2 flex flex-col items-center justify-center group rounded-sm">
                        <span class="font-bold text-sm group-hover:text-white transition-colors">AI Auto-Place</span>
                        <span class="text-[9px] text-gray-400 group-hover:text-gray-200">Generate</span>
                    </button>
                    <button onclick="askAiToAnalyze()" id="btnAiAnalyze" class="btn-magic mobile-touch-target py-3 px-2 flex flex-col items-center justify-center group rounded-sm">
                        <span class="font-bold text-sm group-hover:text-white transition-colors">AI DRC Check</span>
                        <span class="text-[9px] text-gray-400 group-hover:text-gray-200">Critique</span>
                    </button>
                </div>
                <div id="aiLoading" class="hidden mt-4 text-center">
                    <div class="flex flex-col items-center justify-center gap-2">
                        <div class="spell-loader"></div>
                        <span class="text-xs text-[#d4af37] italic font-serif">Consulting the ancient design rules...</span>
                    </div>
                </div>
            </div>

            <!-- Palette -->
            <div class="magic-panel p-6 rounded-sm order-last">
                 <h2 class="text-green-500 font-bold mb-3 text-xs tracking-widest uppercase">
                    III. Manual Placement
                </h2>
                <div id="paletteContainer" class="flex flex-wrap gap-2 justify-center">
                    <!-- JS will populate buttons here -->
                </div>
            </div>

        </div>

        <!-- Right: Visual Canvas -->
        <!-- Order-2 ensures this appears after controls on mobile -->
        <div class="lg:col-span-8 flex flex-col gap-6 order-2 lg:order-2">
            
            <!-- Canvas -->
            <div class="magic-panel p-6 rounded-sm flex flex-col relative min-h-[450px]">
                
                <!-- Toolbar -->
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 border-b border-[#4a3b2a] pb-4">
                     <h2 class="text-[#d4af37] font-bold text-lg tracking-wide magic-font flex items-center gap-2">
                         <span>üìú</span> Layout Canvas
                     </h2>
                     <div class="flex items-center gap-3 bg-black/40 px-4 py-2 rounded-full border border-[#4a3b2a]">
                        <span class="text-[10px] text-purple-300 font-bold whitespace-nowrap uppercase tracking-widest">
                            Gradient Sim:
                        </span>
                        <input type="range" id="gradStrength" min="0" max="20" value="0" class="flex-1 w-24">
                        <span id="gradValDisplay" class="font-bold text-[#d4af37] text-sm w-10 text-right">0%</span>
                     </div>
                </div>

                <!-- Viewport -->
                <div class="flex-1 overflow-auto bg-[#0a0a0a] p-6 relative flex items-center justify-center rounded border border-[#4a3b2a] shadow-inner" id="canvasWrapper">
                    
                    <!-- Decorative Background -->
                    <div class="absolute inset-0 opacity-10 pointer-events-none bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')]"></div>

                    <!-- Grid Container -->
                    <div id="gridContainer" class="grid gap-2 relative p-4 z-10 transition-all">
                        <!-- Cells generated by JS -->
                    </div>
                    
                </div>
                
                <!-- Overlay Info -->
                <div class="absolute bottom-4 right-4 pointer-events-none opacity-50 text-[10px] text-[#d4af37] font-serif italic">
                     Ideal Center: <span id="idealCenterVal">--</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Stats Table -->
                <div class="magic-panel p-6 flex flex-col h-72 rounded-sm">
                    <h2 class="text-[#d4af37] font-bold mb-2 pb-2 border-b border-[#4a3b2a] text-xs uppercase tracking-wider">
                        Matching Statistics
                    </h2>
                    <div class="overflow-y-auto stats-container flex-1 pr-1 bg-black/20 border border-[#4a3b2a] rounded">
                        <table class="w-full text-left text-sm stats-table">
                            <thead class="bg-[#1a1a1a] text-gray-500 sticky top-0 backdrop-blur-sm">
                                <tr>
                                    <th class="px-3 py-2">Device</th>
                                    <th class="px-3 py-2 text-right">Count</th>
                                    <th class="px-3 py-2 text-right">Offset (Œî)</th>
                                </tr>
                            </thead>
                            <tbody id="statsBody" class="text-gray-300"></tbody>
                        </table>
                    </div>
                </div>

                <!-- AI Output Box -->
                <div class="magic-panel p-6 flex flex-col h-72 rounded-sm bg-black/80">
                    <div class="border-b border-[#4a3b2a] pb-2 flex justify-between items-center mb-2">
                        <span class="text-blue-400 font-bold text-xs tracking-wider uppercase">AI Advisor Report</span>
                        <span class="text-[10px] text-gray-600 border border-gray-700 px-1 rounded">Gemini</span>
                    </div>
                    <div id="aiOutput" class="flex-1 overflow-y-auto text-sm leading-relaxed text-[#f0e6d2] font-serif">
                        <div class="h-full flex flex-col items-center justify-center text-gray-500 italic text-center opacity-60">
                            <span class="text-2xl mb-2">‚ú®</span>
                            <span>"I await your command,<br>Master Architect."</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const apiKey = ""; // System will provide API key at runtime

        // --- House Colors & Device Types ---
        const COLORS = [
            { bg: 'bg-[#740001]', border: 'border-[#d3a625]', text: 'text-[#eeba30]', hex: '#740001', label: 'A', class: 'Gryffindor' }, 
            { bg: 'bg-[#1a472a]', border: 'border-[#aaaaaa]', text: 'text-[#aaaaaa]', hex: '#1a472a', label: 'B', class: 'Slytherin' },   
            { bg: 'bg-[#0e1a40]', border: 'border-[#946b2d]', text: 'text-[#946b2d]', hex: '#0e1a40', label: 'C', class: 'Ravenclaw' }, 
            { bg: 'bg-[#ecb939]', border: 'border-[#372e29]', text: 'text-[#372e29]', hex: '#ecb939', label: 'D', class: 'Hufflepuff' }, 
            { bg: 'bg-[#4b0082]', border: 'border-[#a366ff]', text: 'text-[#e0d0ff]', hex: '#4b0082', label: 'E', class: 'Magic' }, 
            { bg: 'bg-[#008b8b]', border: 'border-[#00ffff]', text: 'text-[#e0ffff]', hex: '#008b8b', label: 'F', class: 'Ice' },   
            { bg: 'bg-[#8b0000]', border: 'border-[#ff4500]', text: 'text-[#ffe4e1]', hex: '#8b0000', label: 'G', class: 'Fire' },   
            { bg: 'bg-[#2f4f4f]', border: 'border-[#708090]', text: 'text-[#f0f8ff]', hex: '#2f4f4f', label: 'H', class: 'Stone' } 
        ];
        const LABELS = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

        let rows = 4;
        let cols = 4;
        let deviceTypeCount = 2; 
        let targetCounts = [8, 8, 0, 0, 0, 0, 0, 0]; 
        let gridData = []; 
        let activeBrush = 0; 
        let currentErrors = {};

        // --- DOM Elements ---
        const gridEl = document.getElementById('gridContainer');
        const paletteEl = document.getElementById('paletteContainer');
        const quantityInputsEl = document.getElementById('quantityInputsContainer');
        const capacityStatusEl = document.getElementById('capacityStatus');
        const colInput = document.getElementById('colInput');
        const rowInput = document.getElementById('rowInput');
        const deviceCountInput = document.getElementById('deviceCountInput');
        const deviceCountVal = document.getElementById('deviceCountVal');
        const statsBody = document.getElementById('statsBody');
        const gradStrengthInput = document.getElementById('gradStrength');
        const aiOutputEl = document.getElementById('aiOutput');
        const aiLoadingEl = document.getElementById('aiLoading');

        // --- Helper for +/- buttons ---
        function adjustVal(id, delta) {
            const input = document.getElementById(id);
            let val = parseInt(input.value) + delta;
            if (val >= parseInt(input.min) && val <= parseInt(input.max)) {
                input.value = val;
                // Trigger change manually
                const event = new Event('change');
                input.dispatchEvent(event);
            }
        }

        // --- Initialization ---
        function init() {
            deviceCountInput.addEventListener('input', (e) => {
                deviceTypeCount = parseInt(e.target.value);
                deviceCountVal.textContent = deviceTypeCount;
                renderQuantityInputs(); 
                renderPalette();
                updateCapacityStatus();
            });

            colInput.addEventListener('change', () => { generateGrid(); updateCapacityStatus(); });
            rowInput.addEventListener('change', () => { generateGrid(); updateCapacityStatus(); });

            gradStrengthInput.addEventListener('input', (e) => {
                document.getElementById('gradValDisplay').textContent = e.target.value + '%';
                renderCells(); 
                calculateStats();
            });

            renderQuantityInputs();
            renderPalette();
            generateGrid();
        }

        function updateCapacityStatus() {
            const r = parseInt(rowInput.value) || 0;
            const c = parseInt(colInput.value) || 0;
            const totalSlots = r * c;
            let totalNeeded = 0;
            for(let i=0; i<deviceTypeCount; i++) totalNeeded += (targetCounts[i] || 0);
            capacityStatusEl.textContent = `${totalNeeded} / ${totalSlots}`;
            
            if (totalNeeded > totalSlots) {
                capacityStatusEl.className = "font-serif text-lg text-red-500 drop-shadow-[0_0_2px_red]";
            } else if (totalNeeded === totalSlots) {
                capacityStatusEl.className = "font-serif text-lg text-green-500 drop-shadow-[0_0_2px_green]";
            } else {
                capacityStatusEl.className = "font-serif text-lg text-gray-400";
            }
        }

        function renderQuantityInputs() {
            quantityInputsEl.innerHTML = '';
            for(let i=0; i<deviceTypeCount; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = `flex items-center gap-2 p-1 border-l-2 border-[#4a3b2a] bg-black/30 rounded`;
                
                const label = document.createElement('span');
                label.className = `magic-font font-bold w-6 text-center text-[#d4af37]`;
                label.innerText = LABELS[i];
                
                const input = document.createElement('input');
                input.type = 'number';
                input.min = '0';
                input.className = "w-full bg-transparent text-[#f0e6d2] text-right text-base outline-none font-serif";
                input.value = targetCounts[i] || 0;
                input.addEventListener('input', (e) => {
                    let val = parseInt(e.target.value);
                    if(isNaN(val) || val < 0) val = 0;
                    targetCounts[i] = val;
                    updateCapacityStatus();
                    calculateStats(); 
                });
                wrapper.appendChild(label);
                wrapper.appendChild(input);
                quantityInputsEl.appendChild(wrapper);
            }
            updateCapacityStatus();
        }

        function renderPalette() {
            paletteEl.innerHTML = '';
            for(let i=0; i<deviceTypeCount; i++) {
                const btn = document.createElement('button');
                const isSelected = (i === activeBrush);
                
                // Magical Button Style
                let baseClass = `flex flex-col items-center justify-center w-12 h-12 border transition-all ${COLORS[i].bg} ${COLORS[i].border}`;
                
                if (isSelected) {
                    btn.className = `${baseClass} ring-2 ring-[#d4af37] z-10 brightness-110 shadow-[0_0_10px_#d4af37] scale-110`;
                } else {
                    btn.className = `${baseClass} opacity-60 hover:opacity-100 bg-opacity-40`;
                }

                btn.innerHTML = `<span class="magic-font font-bold text-lg ${COLORS[i].text}">${LABELS[i]}</span>`;
                btn.onclick = () => { activeBrush = i; renderPalette(); };
                paletteEl.appendChild(btn);
            }
        }

        function generateGrid() {
            cols = parseInt(colInput.value);
            rows = parseInt(rowInput.value);
            // Mobile Optimization - Responsive sizing
            let cellSize = cols > 8 ? 35 : 45;
            
            gridEl.style.gridTemplateColumns = `repeat(${cols}, ${cellSize}px)`; 
            gridEl.style.gridTemplateRows = `repeat(${rows}, ${cellSize}px)`;
            
            gridData = [];
            for(let r=0; r<rows; r++) gridData[r] = new Array(cols).fill(-1);

            let remainingCounts = [];
            for(let i=0; i<deviceTypeCount; i++) remainingCounts[i] = targetCounts[i] || 0;

             const centerR = (rows-1)/2;
            const centerC = (cols-1)/2;
            const hasCenter = (rows % 2 !== 0) && (cols % 2 !== 0);

            if (hasCenter) {
                let bestIdx = -1;
                for(let i=0; i<deviceTypeCount; i++) {
                    if (remainingCounts[i] > 0 && remainingCounts[i] % 2 !== 0) { bestIdx = i; break; }
                }
                if (bestIdx === -1) { for(let i=0; i<deviceTypeCount; i++) if (remainingCounts[i] > 0) { bestIdx = i; break; } }
                if (bestIdx !== -1) { gridData[centerR][centerC] = bestIdx; remainingCounts[bestIdx]--; }
            }

            let typePointer = 0; 
            for(let r=0; r<rows; r++) {
                for(let c=0; c<cols; c++) {
                    if (gridData[r][c] !== -1) continue; 
                    const symR = rows - 1 - r;
                    const symC = cols - 1 - c;
                    if (r === symR && c === symC) continue; 

                    let foundType = -1;
                    let attempts = 0;
                    while (attempts < deviceTypeCount) {
                        const currentType = typePointer % deviceTypeCount;
                        if (remainingCounts[currentType] >= 2) { foundType = currentType; typePointer++; break; }
                        typePointer++; attempts++;
                    }

                    if (foundType !== -1) {
                        gridData[r][c] = foundType; gridData[symR][symC] = foundType; remainingCounts[foundType] -= 2;
                    } else {
                        for(let i=0; i<deviceTypeCount; i++) if (remainingCounts[i] > 0) { gridData[r][c] = i; remainingCounts[i]--; break; }
                        for(let i=0; i<deviceTypeCount; i++) if (remainingCounts[i] > 0) { gridData[symR][symC] = i; remainingCounts[i]--; break; }
                    }
                }
            }
            renderCells();
            calculateStats();
            updateCapacityStatus();
            aiOutputEl.innerHTML = '<div class="opacity-60 text-center mt-10">Grid reset spell cast.<br>Ready for new layout.</div>';
        }

        function renderCells() {
            gridEl.innerHTML = '';
            const gradStrength = parseInt(gradStrengthInput.value) / 100;
            const centerX = (cols-1)/2;
            const centerY = (rows-1)/2;
            
            // Adjust size dynamically for rendering
            let cellSize = cols > 8 ? 35 : 45;

            for(let r=0; r<rows; r++) {
                for(let c=0; c<cols; c++) {
                    const cellVal = gridData[r][c];
                    const cell = document.createElement('div');
                    
                    cell.style.width = `${cellSize}px`;
                    cell.style.height = `${cellSize}px`;
                    
                    let baseClass = 'flex items-center justify-center font-bold text-xl cursor-pointer select-none rune-cell relative';
                    
                    if (cellVal >= 0 && cellVal < 8) { 
                        const colorSet = COLORS[cellVal];
                        cell.className = `${baseClass} ${colorSet.bg} ${colorSet.border} ${colorSet.text}`;
                        cell.innerText = LABELS[cellVal]; 
                    } else {
                        cell.className = `${baseClass} bg-[#0f172a] border-[#2d3748] text-gray-700`;
                        cell.innerText = '¬∑';
                    }

                    if (gradStrength > 0) {
                        const dist = (c - centerX) + (r - centerY);
                        const factor = 1 + (dist * gradStrength * 0.1); 
                        if (cellVal >= 0) cell.style.filter = `brightness(${factor})`;
                        if (gradStrength > 0.1) cell.classList.add('animate-pulse');
                    }

                    cell.onclick = () => { gridData[r][c] = activeBrush; renderCells(); calculateStats(); };
                    cell.oncontextmenu = (e) => { e.preventDefault(); gridData[r][c] = -1; renderCells(); calculateStats(); }
                    gridEl.appendChild(cell);
                }
            }
        }

        function calculateStats() {
            const idealX = (cols - 1) / 2;
            const idealY = (rows - 1) / 2;
            document.getElementById('idealCenterVal').innerText = `(${idealX.toFixed(1)}, ${idealY.toFixed(1)})`;
            let stats = {};
            currentErrors = {}; 
            for(let i=0; i<deviceTypeCount; i++) stats[i] = { sumX:0, sumY:0, count:0 };

            for(let r=0; r<rows; r++) {
                for(let c=0; c<cols; c++) {
                    const val = gridData[r][c];
                    if (val >= 0 && val < deviceTypeCount) {
                        stats[val].sumX += c; stats[val].sumY += r; stats[val].count++;
                    }
                }
            }

            statsBody.innerHTML = '';
            for(let i=0; i<deviceTypeCount; i++) {
                const s = stats[i];
                const target = targetCounts[i] || 0;
                const tr = document.createElement('tr');
                tr.className = "border-b border-[#4a3b2a] hover:bg-white/5";
                
                let errorText = "--";
                let errorClass = "text-gray-500";
                let countClass = s.count !== target ? "text-red-400 font-bold" : "text-green-500 font-bold";

                if (s.count > 0) {
                    const cx = s.sumX / s.count;
                    const cy = s.sumY / s.count;
                    const dist = Math.sqrt(Math.pow(cx - idealX, 2) + Math.pow(cy - idealY, 2));
                    errorText = dist.toFixed(3);
                    if (dist < 0.01) errorClass = "text-green-400 font-bold text-shadow-glow";
                    else if (dist < 0.5) errorClass = "text-yellow-400";
                    else errorClass = "text-red-400";
                    
                    currentErrors[LABELS[i]] = dist.toFixed(4);
                } else {
                    currentErrors[LABELS[i]] = "N/A";
                }

                tr.innerHTML = `
                    <td class="px-3 py-2 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full ${COLORS[i].bg} border border-white/20"></span>
                        <span class="font-serif text-[#f0e6d2]">${LABELS[i]}</span>
                    </td>
                    <td class="px-3 py-2 text-right ${countClass} font-serif">${s.count}/${target}</td>
                    <td class="px-3 py-2 font-mono ${errorClass} text-right">${errorText}</td>
                `;
                statsBody.appendChild(tr);
            }
        }

        // --- GEMINI AI FUNCTIONS (Wizard Professor Persona) ---
        
        async function callGemini(prompt) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                return null;
            }
        }

        async function askAiToAnalyze() {
            setAiLoading(true);
            aiOutputEl.innerHTML = '';
            
            let gridStr = gridData.map(row => row.map(v => v === -1 ? '.' : LABELS[v]).join(" ")).join("\n");
            let statsStr = JSON.stringify(currentErrors);
            
            const prompt = `
            Act as a Senior Analog IC Layout Engineer who also happens to be a Professor at Hogwarts.
            You must use correct technical terminology (Mismatch, Gradient, Common Centroid, Threshold Voltage, Oxide thickness).
            However, your tone should be magical and wise.
            
            Task: Analyze this layout array.
            Grid (${rows}x${cols}):
            ${gridStr}
            
            Mismatch Offsets:
            ${statsStr}
            
            Critique points:
            1. Symmetry of Device placement.
            2. Susceptibility to process gradients (Linear/Radial).
            3. Recommendation for dummy devices or guard rings.
            
            Keep response concise and bulleted.
            `;

            const result = await callGemini(prompt);
            setAiLoading(false);
            
            if (result) {
                let formatted = result.replace(/\n/g, '<br>');
                // Highlight keywords
                formatted = formatted.replace(/Excellent|Perfect/g, '<span class="text-green-400 font-bold">Excellent</span>');
                formatted = formatted.replace(/Poor|Risk/g, '<span class="text-red-400 font-bold">Risk</span>');
                
                aiOutputEl.innerHTML = `${formatted}`;
            } else {
                aiOutputEl.innerHTML = '<span class="text-red-400">The owl network is down. (Connection Error)</span>';
            }
        }

        async function askAiToGenerate() {
            setAiLoading(true);
            aiOutputEl.innerHTML = '<span class="text-[#d4af37] animate-pulse">Casting Auto-Place Spell...</span>';
            
            let deviceInfo = [];
            for(let i=0; i<deviceTypeCount; i++) {
                deviceInfo.push(`Device ${LABELS[i]} (ID=${i}): QTY=${targetCounts[i]}`);
            }
            
            const prompt = `
            Act as an Expert Layout Algorithm Wizard.
            Task: Generate a 2D Common Centroid Array.
            Specs: ${rows}x${cols}.
            Devices:
            ${deviceInfo.join(', ')}.
            
            Constraints:
            1. Use integers ${Array.from({length:deviceTypeCount},(_,i)=>i).join(',')} for devices, -1 for empty.
            2. Optimize for Common Centroid to minimize Systematic Mismatch.
            3. Output ONLY a raw JSON 2D array.
            `;

            const result = await callGemini(prompt);
            setAiLoading(false);

            if (result) {
                try {
                    let cleanJson = result.replace(/```json/g, '').replace(/```/g, '').trim();
                    let newGrid = JSON.parse(cleanJson);
                    
                    if (newGrid.length === rows && newGrid[0].length === cols) {
                        gridData = newGrid;
                        renderCells();
                        calculateStats();
                        updateCapacityStatus();
                        aiOutputEl.innerHTML = '<div><span class="text-green-400">‚úì Grid updated.</span><br>Common Centroid pattern applied successfully.</div>';
                    } else {
                        throw new Error("Dimension mismatch");
                    }
                } catch (e) {
                    console.error(e);
                    aiOutputEl.innerHTML = '<span class="text-red-400">Spell Backfired (JSON Error).</span>';
                }
            } else {
                aiOutputEl.innerHTML = '<span class="text-red-400">Server Unreachable.</span>';
            }
        }

        function setAiLoading(isLoading) {
            if (isLoading) {
                aiLoadingEl.classList.remove('hidden');
                document.getElementById('btnAiGen').disabled = true;
                document.getElementById('btnAiAnalyze').disabled = true;
                document.getElementById('btnAiGen').classList.add('opacity-50');
            } else {
                aiLoadingEl.classList.add('hidden');
                document.getElementById('btnAiGen').disabled = false;
                document.getElementById('btnAiAnalyze').disabled = false;
                document.getElementById('btnAiGen').classList.remove('opacity-50');
            }
        }

        // Run Init
        init();
    </script>
</body>
</html>